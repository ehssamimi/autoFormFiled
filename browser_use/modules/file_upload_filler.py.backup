"""
File Upload Filler Module
Handles file input fields
"""

import os
from pathlib import Path
from typing import List
from .utils import resolve_file_path


class FileUploadFiller:
    """
    Handles file upload fields
    """
    
    @staticmethod
    async def fill(page, selectors: List[str], file_path: str, field_name: str = '') -> bool:
        """
        Upload a file
        """
        print(f'\nüìÅ FILE UPLOAD START: {field_name}')
        print(f'   Selectors: {selectors}')
        print(f'   File path: {file_path}')
        
        # Resolve path
        abs_path = resolve_file_path(file_path, base_dir=os.path.dirname(os.path.dirname(__file__)))
        print(f'   Absolute path: {abs_path}')
        
        if not os.path.exists(abs_path):
            print(f'‚ùå File not found: {abs_path}')
            print(f'   Tried path: {file_path}')
            return False
        
        file_size = os.path.getsize(abs_path)
        print(f'‚úÖ File exists, size: {file_size} bytes')
        
        # Strategy 0: Try clicking span with _add suffix FIRST (for finest-jobs.com style)
        for selector in selectors:
            try:
                import re
                name_match = re.search(r'name=["\']([^"\']+)["\']', selector)
                id_match = re.search(r'#([\w-]+)', selector) or re.search(r'id=["\']([^"\']+)["\']', selector)
                
                if name_match or id_match:
                    name = name_match.group(1) if name_match else None
                    field_id = id_match.group(1) if id_match else None
                    
                    # Find text input to get its id
                    text_input_id = field_id
                    if not text_input_id and name:
                        text_input = page.locator(f'input[name="{name}"]').first
                        if await text_input.count() > 0:
                            text_input_id = await text_input.get_attribute('id')
                    
                    if text_input_id:
                        # Find span with id = textInputId + "_add"
                        add_span_id = f'{text_input_id}_add'
                        add_span = page.locator(f'span#{add_span_id}').first
                        
                        if await add_span.count() > 0:
                            try:
                                # Find file input inside span
                                file_input_in_span = add_span.locator('input[type="file"]').first
                                
                                if await file_input_in_span.count() > 0:
                                    print(f'üîç Found span#{add_span_id} with file input, trying upload...')
                                    # Scroll to span
                                    await add_span.scroll_into_view_if_needed()
                                    await page.wait_for_timeout(200)
                                    
                                    # Click the span first
                                    try:
                                        await add_span.click(timeout=2000)
                                        await page.wait_for_timeout(300)
                                    except Exception:
                                        pass
                                    
                                    # Set the file
                                    try:
                                        await file_input_in_span.set_input_files(abs_path, timeout=10000)
                                        
                                        # Trigger change event
                                        await file_input_in_span.evaluate("""
                                            (input) => {
                                                const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                                input.dispatchEvent(changeEvent);
                                            }
                                        """)
                                        
                                        # Also trigger on span
                                        await add_span.evaluate("""
                                            (span) => {
                                                const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                                span.dispatchEvent(changeEvent);
                                            }
                                        """)
                                        
                                        print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (via span _add click)')
                                        await page.wait_for_timeout(2000)
                                        
                                        # Verify file was set
                                        file_count = await file_input_in_span.evaluate("""
                                            (input) => {
                                                return input.files ? input.files.length : 0;
                                            }
                                        """)
                                        
                                        if file_count > 0:
                                            return True
                                    except Exception as set_error:
                                        print(f'‚ö†Ô∏è  Error setting file in span: {str(set_error)}')
                            except Exception:
                                pass
            except Exception:
                continue
        
        # Strategy 0.5: Pattern-based detection for common file upload patterns
        # Pattern: label[for="id"] containing input[type="file"][style*="display:none"] and button
        print(f'\nüîç [PATTERN DETECTION] Looking for common file upload patterns...')
        try:
            # Find all file inputs with display:none
            all_hidden_file_inputs = await page.locator('input[type="file"]').all()
            for file_input in all_hidden_file_inputs:
                try:
                    file_id = await file_input.get_attribute('id')
                    file_name = await file_input.get_attribute('name')
                    file_display = await file_input.evaluate("""
                        (input) => {
                            return window.getComputedStyle(input).display;
                        }
                    """)
                    
                    # Check if this matches our pattern (hidden file input)
                    if file_display == 'none' and (file_id or file_name):
                        print(f'üîç [PATTERN] Found hidden file input: id="{file_id}", name="{file_name}"')
                        
                        # Try to find label with for attribute
                        label = None
                        if file_id:
                            label = page.locator(f'label[for="{file_id}"]').first
                            if await label.count() > 0:
                                print(f'üîç [PATTERN] Found label[for="{file_id}"]')
                        
                        # If no label by for, try parent label
                        if not label or await label.count() == 0:
                            try:
                                # Get parent element
                                parent = await file_input.evaluate_handle("""
                                    (input) => {
                                        return input.parentElement;
                                    }
                                """)
                                if parent:
                                    # Check if parent is a label
                                    parent_tag = await parent.evaluate("""
                                        (el) => {
                                            return el.tagName.toLowerCase();
                                        }
                                    """)
                                    if parent_tag == 'label':
                                        label = parent
                                        print(f'üîç [PATTERN] Found parent label')
                            except Exception:
                                pass
                        
                        if label and await label.count() > 0:
                            # Find button inside label
                            button_in_label = label.locator('button').first
                            if await button_in_label.count() > 0:
                                button_text = await button_in_label.inner_text()
                                print(f'üîç [PATTERN] Found button in label with text: "{button_text}"')
                                
                                # Check if this matches our selectors
                                # If no selectors provided, try all patterns
                                # If selectors provided, check if this file input matches any
                                matches_selector = False
                                if not selectors or len(selectors) == 0:
                                    matches_selector = True  # No selectors = try all
                                else:
                                    for sel in selectors:
                                        # Check if selector contains file_id or file_name
                                        if file_id and (file_id in sel or f'#{file_id}' in sel or f'id="{file_id}"' in sel):
                                            matches_selector = True
                                            print(f'üîç [PATTERN] Matched selector by id: {sel}')
                                            break
                                        if file_name and (file_name in sel or f'name="{file_name}"' in sel or f'[name="{file_name}"]' in sel):
                                            matches_selector = True
                                            print(f'üîç [PATTERN] Matched selector by name: {sel}')
                                            break
                                
                                if matches_selector:
                                    try:
                                        print(f'‚úÖ [PATTERN] Pattern matched! Attempting upload...')
                                        
                                        # Scroll to button
                                        await button_in_label.scroll_into_view_if_needed()
                                        await page.wait_for_timeout(300)
                                        
                                        # Click the button
                                        print(f'üîç [PATTERN] Clicking button...')
                                        await button_in_label.click(timeout=3000)
                                        await page.wait_for_timeout(500)
                                        
                                        # Set the file
                                        print(f'üîç [PATTERN] Setting file on input[type="file"][id="{file_id}"]...')
                                        await file_input.set_input_files(abs_path, timeout=10000)
                                        await page.wait_for_timeout(1000)
                                        
                                        # Verify file was set
                                        file_count = await file_input.evaluate("""
                                            (input) => {
                                                return input.files ? input.files.length : 0;
                                            }
                                        """)
                                        
                                        if file_count > 0:
                                            file_name_uploaded = await file_input.evaluate("""
                                                (input) => {
                                                    return input.files && input.files[0] ? input.files[0].name : '';
                                                }
                                            """)
                                            print(f'‚úÖ [PATTERN] {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (pattern-based) - File count: {file_count}, File name: "{file_name_uploaded}"')
                                            
                                            # Trigger events
                                            await file_input.evaluate("""
                                                (input) => {
                                                    const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(changeEvent);
                                                    const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(inputEvent);
                                                    
                                                    const label = input.closest('label');
                                                    if (label) {
                                                        label.dispatchEvent(new Event('change', { bubbles: true }));
                                                    }
                                                    
                                                    const form = input.closest('form');
                                                    if (form) {
                                                        form.dispatchEvent(new Event('change', { bubbles: true }));
                                                        form.dispatchEvent(new Event('input', { bubbles: true }));
                                                    }
                                                }
                                            """)
                                            
                                            await page.wait_for_timeout(2000)
                                            
                                            # Check if submit button is enabled
                                            try:
                                                submit_buttons = await page.locator('input[type="submit"], button[type="submit"]').all()
                                                for submit_btn in submit_buttons:
                                                    is_disabled = await submit_btn.get_attribute('disabled')
                                                    if is_disabled is None:
                                                        print(f'‚úÖ [PATTERN] Submit button is now enabled after file upload')
                                                        break
                                            except Exception:
                                                pass
                                            
                                            return True
                                        else:
                                            print(f'‚ö†Ô∏è  [PATTERN] File was set but file count is 0')
                                    except Exception as pattern_error:
                                        print(f'‚ö†Ô∏è  [PATTERN] Pattern-based upload failed: {str(pattern_error)}')
                                        import traceback
                                        print(traceback.format_exc())
                except Exception as e:
                    print(f'‚ö†Ô∏è  [PATTERN] Error checking file input: {str(e)}')
                    continue
        except Exception as e:
            print(f'‚ö†Ô∏è  [PATTERN] Pattern detection error: {str(e)}')
        
        # Strategy 1: Try to find the actual file input (even if hidden)
        # IMPORTANT: For custom file uploads, find the button/div that triggers the upload
        for selector in selectors:
            print(f'\nüîç Trying selector: {selector}')
            try:
                import re
                name_match = re.search(r'name=["\']([^"\']+)["\']', selector)
                id_match = re.search(r'#([\w-]+)', selector) or re.search(r'id=["\']([^"\']+)["\']', selector)
                
                if name_match:
                    name = name_match.group(1)
                    
                    # Step 0: For custom file uploads, find the button/div that triggers upload
                    # IMPORTANT: This must be done FIRST before trying direct file input access
                    file_input_id = None
                    if id_match:
                        file_input_id = id_match.group(1)
                    
                    # Strategy A: Find file input by name first, then find its label and button
                    file_input_by_name = page.locator(f'input[type="file"][name="{name}"]').first
                    if await file_input_by_name.count() > 0:
                        file_input_id_from_name = await file_input_by_name.get_attribute('id')
                        if file_input_id_from_name:
                            print(f'üîç Found file input with name="{name}", id="{file_input_id_from_name}"')
                            
                            # Find label with for attribute pointing to this file input
                            label_by_for = page.locator(f'label[for="{file_input_id_from_name}"]').first
                            if await label_by_for.count() > 0:
                                print(f'üîç Found label[for="{file_input_id_from_name}"]')
                                
                                # Find button inside label (prioritize button with "Attach" text or any button)
                                button_in_label = label_by_for.locator('button').first
                                if await button_in_label.count() > 0:
                                    try:
                                        button_text = await button_in_label.inner_text()
                                        print(f'üîç Found button in label with text: "{button_text}"')
                                        
                                        # Scroll to button
                                        await button_in_label.scroll_into_view_if_needed()
                                        await page.wait_for_timeout(300)
                                        
                                        # Click the button to trigger file input
                                        print(f'üîç Clicking button to trigger file input...')
                                        await button_in_label.click(timeout=3000)
                                        await page.wait_for_timeout(500)
                                        
                                        # Now try to set the file on the hidden input
                                        print(f'üîç Setting file on input[type="file"][id="{file_input_id_from_name}"]...')
                                        await file_input_by_name.set_input_files(abs_path, timeout=10000)
                                        
                                        # Wait a bit for file to be processed
                                        await page.wait_for_timeout(1000)
                                        
                                        # Verify file was set
                                        file_count = await file_input_by_name.evaluate("""
                                            (input) => {
                                                return input.files ? input.files.length : 0;
                                            }
                                        """)
                                        
                                        if file_count > 0:
                                            file_name = await file_input_by_name.evaluate("""
                                                (input) => {
                                                    return input.files && input.files[0] ? input.files[0].name : '';
                                                }
                                            """)
                                            print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (via button click) - File count: {file_count}, File name: "{file_name}"')
                                            
                                            # Trigger change event to notify the form
                                            await file_input_by_name.evaluate("""
                                                (input) => {
                                                    const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(changeEvent);
                                                    const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(inputEvent);
                                                    
                                                    // Also trigger on the label and form if they exist
                                                    const label = input.closest('label');
                                                    if (label) {
                                                        label.dispatchEvent(new Event('change', { bubbles: true }));
                                                    }
                                                    
                                                    const form = input.closest('form');
                                                    if (form) {
                                                        form.dispatchEvent(new Event('change', { bubbles: true }));
                                                        // Trigger form validation
                                                        const formEvent = new Event('input', { bubbles: true });
                                                        form.dispatchEvent(formEvent);
                                                    }
                                                }
                                            """)
                                            
                                            # Wait for form validation to update submit button
                                            await page.wait_for_timeout(2000)
                                            
                                            # Check if submit button is now enabled
                                            try:
                                                submit_buttons = await page.locator('input[type="submit"], button[type="submit"]').all()
                                                for submit_btn in submit_buttons:
                                                    is_disabled = await submit_btn.get_attribute('disabled')
                                                    if is_disabled is None:
                                                        print(f'‚úÖ Submit button is now enabled after file upload')
                                                        break
                                            except Exception:
                                                pass
                                            
                                            return True
                                        else:
                                            print(f'‚ö†Ô∏è  File was set but file count is 0, trying alternative method...')
                                    except Exception as btn_error:
                                        print(f'‚ö†Ô∏è  Button click method failed: {str(btn_error)}')
                                        import traceback
                                        print(traceback.format_exc())
                    
                    # Strategy B: Try with file_input_id if available
                    if file_input_id:
                        label = page.locator(f'label[for="{file_input_id}"]').first
                        if await label.count() > 0:
                            # Find button inside label
                            button_in_label = label.locator('button').first
                            if await button_in_label.count() > 0:
                                try:
                                    button_text = await button_in_label.inner_text()
                                    print(f'üîç Found button in label[for="{file_input_id}"] with text: "{button_text}", clicking...')
                                    await button_in_label.scroll_into_view_if_needed()
                                    await page.wait_for_timeout(300)
                                    await button_in_label.click(timeout=3000)
                                    await page.wait_for_timeout(500)
                                    # Now try to set the file
                                    file_input = page.locator(f'input[type="file"][id="{file_input_id}"]').first
                                    if await file_input.count() > 0:
                                        await file_input.set_input_files(abs_path, timeout=10000)
                                        await page.wait_for_timeout(1000)
                                        
                                        # Verify
                                        file_count = await file_input.evaluate("""
                                            (input) => {
                                                return input.files ? input.files.length : 0;
                                            }
                                        """)
                                        if file_count > 0:
                                            file_name = await file_input.evaluate("""
                                                (input) => {
                                                    return input.files && input.files[0] ? input.files[0].name : '';
                                                }
                                            """)
                                            print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (via button click by id) - File count: {file_count}, File name: "{file_name}"')
                                            
                                            # Trigger change event to notify the form
                                            await file_input.evaluate("""
                                                (input) => {
                                                    const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(changeEvent);
                                                    const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                                    input.dispatchEvent(inputEvent);
                                                    
                                                    // Also trigger on the label and form if they exist
                                                    const label = input.closest('label');
                                                    if (label) {
                                                        label.dispatchEvent(new Event('change', { bubbles: true }));
                                                    }
                                                    
                                                    const form = input.closest('form');
                                                    if (form) {
                                                        form.dispatchEvent(new Event('change', { bubbles: true }));
                                                        const formEvent = new Event('input', { bubbles: true });
                                                        form.dispatchEvent(formEvent);
                                                    }
                                                }
                                            """)
                                            
                                            # Wait for form validation to update submit button
                                            await page.wait_for_timeout(2000)
                                            
                                            # Check if submit button is now enabled
                                            try:
                                                submit_buttons = await page.locator('input[type="submit"], button[type="submit"]').all()
                                                for submit_btn in submit_buttons:
                                                    is_disabled = await submit_btn.get_attribute('disabled')
                                                    if is_disabled is None:
                                                        print(f'‚úÖ Submit button is now enabled after file upload')
                                                        break
                                            except Exception:
                                                pass
                                            
                                            await page.wait_for_timeout(1000)
                                            return True
                                except Exception as btn_error:
                                    print(f'‚ö†Ô∏è  Button click method (by id) failed: {str(btn_error)}')
                                    import traceback
                                    print(traceback.format_exc())
                    
                    # Step 1: Try to find file input with this name directly
                    file_input = page.locator(f'input[type="file"][name="{name}"]').first
                    if await file_input.count() > 0:
                        try:
                            await file_input.set_input_files(abs_path)
                            print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (by name)')
                            await page.wait_for_timeout(500)
                            return True
                        except Exception:
                            pass
                    
                    # Step 2: Find text input with this name, get its id, then find file input in span with _add
                    text_input = page.locator(f'input[name="{name}"]').first
                    if await text_input.count() > 0:
                        text_input_id = await text_input.get_attribute('id')
                        if text_input_id:
                            print(f'üîç Found text input with id: {text_input_id}, looking for file input in span with id: {text_input_id}_add')
                            
                            # Find span with id = textInputId + "_add"
                            add_span_id = f'{text_input_id}_add'
                            add_span = page.locator(f'span[id="{add_span_id}"] input[type="file"]').first
                            add_span_count = await add_span.count()
                            print(f'üîç File input in span selector count: {add_span_count}')
                            
                            if add_span_count > 0:
                                try:
                                    # Scroll to the file input
                                    await add_span.scroll_into_view_if_needed()
                                    await page.wait_for_timeout(200)
                                    
                                    # Check if visible
                                    is_file_input_visible = await add_span.is_visible()
                                    print(f'   File input visible: {is_file_input_visible}')
                                    
                                    # Try clicking the file input first
                                    try:
                                        await add_span.click(timeout=1000)
                                        await page.wait_for_timeout(300)
                                    except Exception:
                                        pass
                                    
                                    # Set the file
                                    try:
                                        await add_span.set_input_files(abs_path, timeout=5000)
                                        print(f'‚úÖ File set in input')
                                    except Exception as set_error:
                                        print(f'‚ö†Ô∏è  Error setting file (first attempt): {str(set_error)}')
                                        # Try alternative: use evaluate to click input
                                        try:
                                            await add_span.evaluate("""
                                                (input) => {
                                                    input.click();
                                                }
                                            """)
                                            # Then try setInputFiles again
                                            await add_span.set_input_files(abs_path, timeout=5000)
                                            print(f'‚úÖ File set in input (after click)')
                                        except Exception as retry_error:
                                            print(f'‚ùå Failed to set file after retry: {str(retry_error)}')
                                            raise set_error
                                    
                                    # Wait a bit
                                    await page.wait_for_timeout(500)
                                    
                                    # Verify file was set BEFORE triggering events
                                    files_before_event = await add_span.evaluate("""
                                        (input) => {
                                            return input.files ? input.files.length : 0;
                                        }
                                    """)
                                    print(f'   Files count before events: {files_before_event}')
                                    
                                    # Trigger change event on the file input
                                    await add_span.evaluate("""
                                        (input) => {
                                            const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                            input.dispatchEvent(changeEvent);
                                            
                                            const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                            input.dispatchEvent(inputEvent);
                                            
                                            if (input.files && input.files.length > 0) {
                                                const fileListEvent = new Event('change', { bubbles: true, cancelable: true });
                                                Object.defineProperty(fileListEvent, 'target', { value: input, enumerable: true });
                                                input.dispatchEvent(fileListEvent);
                                            }
                                        }
                                    """)
                                    
                                    # Also trigger on the text input
                                    await text_input.evaluate("""
                                        (input) => {
                                            const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                                            input.dispatchEvent(changeEvent);
                                            
                                            const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                                            input.dispatchEvent(inputEvent);
                                        }
                                    """)
                                    
                                    # Additional: Try to trigger any custom handlers
                                    await page.evaluate(f"""
                                        (inputId) => {{
                                            const textInput = document.getElementById(inputId);
                                            if (textInput) {{
                                                const form = textInput.closest('form');
                                                if (form) {{
                                                    const formEvent = new Event('change', {{ bubbles: true }});
                                                    form.dispatchEvent(formEvent);
                                                }}
                                            }}
                                        }}
                                    """, text_input_id)
                                    
                                    print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (found via text input id)')
                                    
                                    # Wait for upload to process
                                    await page.wait_for_timeout(3000)
                                    
                                    # Verify file was actually set
                                    file_input_files = await add_span.evaluate("""
                                        (input) => {
                                            return input.files ? input.files.length : 0;
                                        }
                                    """)
                                    print(f'   File input files count: {file_input_files}')
                                    
                                    if file_input_files > 0:
                                        file_name = await add_span.evaluate("""
                                            (input) => {
                                                return input.files && input.files[0] ? input.files[0].name : '';
                                            }
                                        """)
                                        print(f'   File name in input: "{file_name}"')
                                    
                                    # Check if the text input shows the file name
                                    text_input_value = await text_input.input_value()
                                    print(f'   Text input value after upload: "{text_input_value}"')
                                    
                                    # Check if preview image is shown
                                    preview_img = page.locator(f'img#{text_input_id}_preview').first
                                    preview_visible = await preview_img.is_visible()
                                    print(f'   Preview image visible: {preview_visible}')
                                    
                                    # Additional verification: Check if any visual indicator appears
                                    upload_indicators = await page.evaluate(f"""
                                        (inputId) => {{
                                            const indicators = [];
                                            const successSelectors = [
                                                `[id*="${{inputId}}"] .success`,
                                                `[id*="${{inputId}}"] .uploaded`,
                                                `[id*="${{inputId}}"] .file-name`,
                                                `[id*="${{inputId}}"] .file-info`
                                            ];
                                            successSelectors.forEach(sel => {{
                                                try {{
                                                    const el = document.querySelector(sel);
                                                    if (el && el.textContent) {{
                                                        indicators.push(el.textContent.trim());
                                                    }}
                                                }} catch (e) {{}}
                                            }});
                                            return indicators;
                                        }}
                                    """, text_input_id)
                                    
                                    if upload_indicators:
                                        print(f'   Upload indicators found: {", ".join(upload_indicators)}')
                                    
                                    # Final verification
                                    if file_input_files > 0 or text_input_value or preview_visible or upload_indicators:
                                        print(f'   ‚úÖ Upload verification: PASSED')
                                        return True
                                    else:
                                        print(f'   ‚ö†Ô∏è  Upload verification: UNCLEAR - file may not be properly uploaded')
                                        return True
                                except Exception as error:
                                    print(f'‚ö†Ô∏è  Error setting file in span: {str(error)}')
                            
                            # Alternative: Find span with id ending in _add that contains file input
                            add_span_alt = page.locator(f'span[id="{add_span_id}"]').first
                            add_span_alt_count = await add_span_alt.count()
                            print(f'üîç Span with id "{add_span_id}" count: {add_span_alt_count}')
                            
                            if add_span_alt_count > 0:
                                file_input_in_span = add_span_alt.locator('input[type="file"]').first
                                file_input_count = await file_input_in_span.count()
                                print(f'üîç File input inside span count: {file_input_count}')
                                
                                if file_input_count > 0:
                                    try:
                                        await file_input_in_span.set_input_files(abs_path)
                                        print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (in span by id)')
                                        await page.wait_for_timeout(1000)
                                        return True
                                    except Exception as error:
                                        print(f'‚ö†Ô∏è  Error setting file in span (alt): {str(error)}')
                
                if id_match:
                    field_id = id_match.group(1)
                    
                    # Try to find file input near this id (in span with _add suffix)
                    add_span_id = f'{field_id}_add'
                    add_span = page.locator(f'span[id="{add_span_id}"] input[type="file"]').first
                    if await add_span.count() > 0:
                        try:
                            await add_span.set_input_files(abs_path)
                            print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (by id span)')
                            await page.wait_for_timeout(500)
                            return True
                        except Exception:
                            pass
                
                # Strategy 2: Try original selector
                locator = page.locator(selector).first
                count = await locator.count()
                
                if count > 0:
                    # Check if it's already a file input
                    input_type = await locator.get_attribute('type')
                    if input_type == 'file':
                        try:
                            await locator.set_input_files(abs_path)
                            print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\'')
                            await page.wait_for_timeout(500)
                            return True
                        except Exception:
                            pass
                    else:
                        # It's a text input, find the file input in the same container
                        try:
                            # Find file input in parent or nearby
                            file_input_nearby = locator.locator('xpath=ancestor::*//input[@type="file"]').first
                            if await file_input_nearby.count() > 0:
                                await file_input_nearby.set_input_files(abs_path)
                                print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (nearby)')
                                await page.wait_for_timeout(500)
                                return True
                        except Exception:
                            pass
            except Exception:
                continue
        
        # Strategy 3: Try to find any file input with matching name attribute
        try:
            import re
            for selector in selectors:
                name_match = re.search(r'name=["\']([^"\']+)["\']', selector)
                if name_match:
                    name = name_match.group(1)
                    # Find all file inputs and check if any has this name
                    all_file_inputs = await page.locator('input[type="file"]').all()
                    for file_input in all_file_inputs:
                        file_input_name = await file_input.get_attribute('name')
                        if file_input_name == name:
                            try:
                                await file_input.set_input_files(abs_path)
                                print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (by name search)')
                                await page.wait_for_timeout(500)
                                return True
                            except Exception:
                                pass
        except Exception:
            pass
        
        # Strategy 4: Try drag-and-drop zone
        try:
            dropzone_selectors = [
                '.dropzone',
                '[class*="dropzone"]',
                '[class*="drop-zone"]',
                '[class*="file-drop"]',
                '[data-dropzone]',
                '[id*="dropzone"]',
                '[id*="drop-zone"]'
            ]
            
            for dropzone_selector in dropzone_selectors:
                try:
                    dropzone = page.locator(dropzone_selector).first
                    if await dropzone.count() > 0:
                        is_visible = await dropzone.is_visible()
                        if is_visible:
                            # Find hidden file input inside dropzone
                            file_input = dropzone.locator('input[type="file"]').first
                            if await file_input.count() > 0:
                                await file_input.set_input_files(abs_path)
                                print(f'‚úÖ {field_name or "File"}: uploaded \'{os.path.basename(abs_path)}\' (drag-and-drop zone)')
                                await page.wait_for_timeout(500)
                                return True
                except Exception:
                    continue
        except Exception:
            pass
        
        print(f'‚ö†Ô∏è  {field_name or "File upload field"} not found')
        return False

